Bootstrap: docker
From: pytorch/pytorch:2.6.0-cuda12.4-cudnn9-runtime

%files
    participant-template/src/predict.py /app/predict.py
    participant-template/src/model.py /app/model.py
    participant-template/src/utils.py /app/utils.py
    participant-template/requirements.txt /app/requirements.txt
    participant-template/init_model.py /app/init_model.py

%post
    # Install necessary packages
    apt-get update && apt-get install -y --no-install-recommends \
        python3-pip \
        python3-setuptools \
        git \
        wget \
        && rm -rf /var/lib/apt/lists/*

    # Install required Python packages from requirements.txt
    pip3 install --no-cache-dir -r /app/requirements.txt

    # Create directories
    mkdir -p /input /output /model

    # Make prediction script executable
    chmod +x /app/predict.py
    chmod +x /app/init_model.py

    # Initialize the model with random weights during container build
    cd /app
    python3 init_model.py
    # Move the generated model weights to the correct location
    mv /app/model/model_weights.pth /model/model_weights.pth

%environment
    export PYTHONPATH=/app:$PYTHONPATH
    export LC_ALL=C
    export MODEL_PATH=/model/model_weights.pth

%runscript
    exec python3 /app/predict.py --input "$1" --output "$2" --model ${MODEL_PATH:-"/model/model_weights.pth"} --device ${3:-"cuda"}